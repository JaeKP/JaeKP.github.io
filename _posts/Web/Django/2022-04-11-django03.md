---
title: Authentication 
author: ë°•ì¬ê²½
date: 2022-04-11
categories: [WEB, Django]
tag: [Django]
---

## 1. Authentication System

Django ì¸ì¦ ì‹œìŠ¤í…œì€ `django.contrib.auth`ì— Django contrib moduleë¡œ ì œê³µí•œë‹¤. 

í•„ìˆ˜ êµ¬ì„±ì€ settings.pyì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìœ¼ë©° INSTALLED_APPS ì„¤ì •ì— ë‚˜ì—´ëœ ì•„ë˜ ë‘ í•­ëª©ìœ¼ë¡œ êµ¬ì„±ëœë‹¤. 

- `django.contrib.auth`: ì¸ì¦ í”„ë ˆì„ì›Œí¬ì˜ í•µì‹¬ê³¼ ê¸°ë³¸ ëª¨ë¸ì„ í¬í•¨í•œë‹¤. 
- `django.contrib.contenttypes`: ì‚¬ìš©ìê°€ ìƒì„±í•œ ëª¨ë¸ê³¼ ê¶Œí•œì„ ì—´ê²¬í•  ìˆ˜ ìˆë‹¤.



ë˜í•œ, DjangoëŠ” Authentication(ì¸ì¦)ê³¼ Authorization(ê¶Œí•œ)ë¶€ì—¬ë¥¼ í•¨ê»˜ ì²˜ë¦¬í•œë‹¤. 

- Authentication: ì‹ ì› í™•ì¸, ì‚¬ìš©ìê°€ ìì‹ ì´ ëˆ„êµ¬ì¸ì§€ í™•ì¸í•˜ëŠ” ê²ƒ
- Authorization: ê¶Œí•œ ë¶€ì—¬, ì¸ì¦ëœ ì‚¬ìš©ìê°€ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ì‘ì—…ì„ ê²°ì •í•œë‹¤. 



`ì¸ì¦ ê´€ë ¨ ì•± ë“±ë¡í•˜ê¸°`

```bash
python manage.py startapp accounts	
```

app ì´ë¦„ì´ ë°˜ë“œì‹œ accountsì¼ í•„ìš”ëŠ” ì—†ì§€ë§Œ, authì™€ ê´€ë ¨í•´ Django ë‚´ë¶€ì ìœ¼ë¡œ accountsë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©ë˜ê³  ìˆê¸° ë–„ë¬¸ì— accountë¡œ ì§€ì •í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.

<br>

## 2. ì¿ í‚¤ì™€ ì„¸ì…˜ 

HTTPë€ Hyper Text Transfer Protocolì˜ ì¤„ì„ë§ì´ë‹¤.

- HTML ë¬¸ì„œì™€ ê°™ì€ ë¦¬ì†ŒìŠ¤(ìì›, ë°ì´í„°)ë“¤ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” í”„ë¡œí† ì½œ(ê·œì¹™, ê·œì•½)
- ì›¹ì—ì„œ ì´ë£¨ì–´ì§€ëŠ” ëª¨ë“  ë°ì´í„° êµí™˜ì˜ ê¸°ì´ˆ
- í´ë¼ì´ì–¸íŠ¸ - ì„œë²„ í”„ë¡œí† ì½œì´ê¸°ë„ í•˜ë‹¤.



`ë¹„ì—°ê²°ì§€í–¥ (connectionless)`

ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë³´ë‚¸ í›„ ì—°ê²°ì„ ëŠëŠ”ë‹¤.



`ë¬´ìƒíƒœ (stateless)`

ì—°ê²°ì„ ëŠëŠ” ìˆœê°€ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ì˜ í†µì‹ ì´ ëë‚˜ë©° í´ë¼ì´ì–¸íŠ¸ì˜ ìƒíƒœ ì •ë³´ê°€ ìœ ì§€ë˜ì§€ ì•ŠëŠ”ë‹¤.

í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ ì£¼ê³  ë°›ëŠ” ë©”ì‹œì§€ë“¤ì€ ì„œë¡œ ì™„ì „íˆ ë…ë¦½ì ì´ë‹¤.



í•˜ì§€ë§Œ, í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°„ì˜ ê´€ê³„ë¥¼ ì§€ì†í•´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤. (ìë™ ë¡œê·¸ì¸, ì¥ë°”êµ¬ë‹ˆ ë“± )

ë˜í•œ ì—°ì†ë˜ì§€ ì•Šìœ¼ë©´ ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ëˆ„êµ¬ì¸ì§€ ê³„ì† ì¸ì¦ì„ í•´ì•¼ í•œë‹¤. 

**ê·¸ë˜ì„œ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ì˜ ì§€ì†ì ì¸ ê´€ê³„ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ì¿ í‚¤ì™€ ì„¸ì…˜ì´ ì¡´ì¬í•œë‹¤.**



### 1) ì¿ í‚¤

> ì„œë²„ê°€ ì‚¬ìš©ìì˜ ì›¹ë¸Œë¼ìš°ì €ì— ì „ì†¡í•˜ëŠ” ì‘ì€ ë°ì´í„° ì¡°ê°ì´ë‹¤.

- ì‚¬ìš©ìê°€ ì›¹ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•  ê²½ìš° í•´ë‹¹ ì›¹ì‚¬ì´íŠ¸ì˜ ì„œë²„ë¥¼ í†µí•´ ì‚¬ìš©ìì˜ ì»´í“¨í„°ì— ì„¤ì¹˜ë˜ëŠ” ì‘ì€ ê¸°ë¡ ì •ë³´ íŒŒì¼ì´ë‹¤.
  - ë¸Œë¼ìš°ì €(í´ë¼ì´ì–¸íŠ¸)ëŠ” ì¿ í‚¤ë¥¼ ë¡œì»¬ì— KEY-VALUEì˜ ë°ì´í„° í˜•ì‹ìœ¼ë¡œ ì €ì¥í•œë‹¤.
  - **ì´ë ‡ê²Œ ì¿ í‚¤ë¥¼ ì €ì¥í•´ ë†“ì•˜ë‹¤ê°€, ë™ì¼í•œ ì„œë²„ì— ì¬ ìš”ì²­ ì‹œ ì €ì¥ëœ ì¿ í‚¤ë¥¼ í•¨ê»˜ ì „ì†¡í•œë‹¤.**
- HTTP ì¿ í‚¤ëŠ” ìƒíƒœê°€ ìˆëŠ” ì„¸ì…˜ì„ ë§Œë“¤ì–´ ì¤€ë‹¤. 
- ì¿ í‚¤ëŠ” ë‘ ìš”ì²­ì´ ë™ì¼í•œ ë¸Œë¼ìš°ì €ì—ì„œ ë“¤ì–´ì™”ëŠ”ì§€ ì•„ë‹Œì§€ë¥¼ íŒë‹¨í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©í•œë‹¤.
  - ì´ë¥¼ ì´ìš©í•´ ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ìˆë‹¤.
  - ìƒíƒœê°€ ì—†ëŠ” HTTP í”„ë¡œí† ì½œì—ì„œ ìƒíƒœ ì •ë³´ë¥¼ ê¸°ì–µì‹œì¼œì£¼ê¸° ë•Œë¬¸ì´ë‹¤.

- ì¿ í‚¤ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ê°€ ì•„ë‹ˆê¸°ë•Œë¬¸ì— í”„ë¡œê·¸ë¨ì²˜ëŸ¼ ì‹¤í–‰ ë  ìˆ˜ ì—†ìœ¼ë©° ì•…ì„±ì½”ë“œë¥¼ ì„¤ì¹˜í•  ìˆ˜ ì—†ì§€ë§Œ, ì‚¬ìš©ìì˜ í–‰ë™ì„ ì¶”ì í•˜ê±°ë‚˜ ì¿ í‚¤ë¥¼ í›”ì³ì„œ í•´ë‹¹ ì‚¬ìš©ìì˜ ê³„ì • ì ‘ê·¼ ê¶Œí•œì„ íšë“ í•  ìˆ˜ë„ ìˆë‹¤. 

**ì¦‰, ì›¹ í˜ì´ì§€ì— ì ‘ì†í•˜ë©´ ìš”ì²­í•œ ì›¹í˜ì´ì§€ë¥¼ ë°›ìœ¼ë©° ì¿ í‚¤ë¥¼ ì €ì¥í•˜ê³ , í´ë¼ì´ì–¸íŠ¸ê°€ ê°™ì€ ì„œë²„ì— ì¬ ìš”ì²­ ì‹œ ìš”ì²­ê³¼ í•¨ê»˜ ì¿ í‚¤ë„ ì „ì†¡í•œë‹¤.** 

1. **í´ë¼ì´ì–¸íŠ¸ê°€ í˜ì´ì§€ë¥¼ ìš”ì²­** 
2. **ì›¹ ì„œë²„ëŠ” ì¿ í‚¤ë¥¼ ìƒì„±í•˜ê³  ì‘ë‹µê³¼ í•¨ê»˜ ì¤€ë‹¤. (set-Cookie ì‘ë‹µ í—¤ë”)**
3. **ë°›ì€ ì¿ í‚¤ë¥¼ í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œì»¬ PCì— ì €ì¥í•œë‹¤.** 
4. **í›„ì—, ê°™ì€ ì„œë²„ì— ì¬ ìš”ì²­í•  ë•Œ ì¿ í‚¤ê°€ ìˆë‹¤ë©´ í•¨ê»˜ ì „ì†¡í•œë‹¤. (Cookie HTTP í—¤ë”**)

<br>

`ì‚¬ìš© ëª©ì `

- ì„¸ì…˜ ê´€ë¦¬: ë¡œê·¸ì¸, ì•„ì´ë”” ìë™ ì™„ì„±, ê³µì§€ í•˜ë£¨ ì•ˆë³´ê¸°, íŒì—… ì²´í¬, ì¥ë°”êµ¬ë‹ˆ ë“±ì˜ ì •ë³´ë¥¼ ê´€ë¦¬í•œë‹¤.
- ê°œì¸í™”: ì‚¬ìš©ì ì„ í˜¸, í…Œë§ˆ ë“±ì˜ ì„¤ì •í•œë‹¤.
- íŠ¸ë˜í‚¹; ì‚¬ìš©ì í–‰ë™ì„ ê¸°ë¡ ë° ë¶„ì„í•œë‹¤.

<br>

`ìˆ˜ëª…`

- Session cookies: í˜„ì¬ ì„¸ì…˜ì´ ì¢…ë£Œë˜ë©´ ì‚­ì œ ëœë‹¤.
  - ë¸Œë¼ìš°ì €ê°€ í˜„ì¬ ì„¸ì…˜ì´ ì¢…ë£Œë˜ëŠ” ì‹œê¸°ë¥¼ ì •ì˜í•œë‹¤.
  - ì¼ë¶€ ë¸Œë¼ìš°ì €ëŠ” ë‹¤ì‹œ ì‹œì‘í•  ë•Œ ì„¸ì…˜ ë³µì›ì„ ì‚¬ìš©í•´ ì„¸ì…˜ ì¿ í‚¤ê°€ ì˜¤ë˜ ì§€ì† ë  ìˆ˜ ìˆë„ë¡ í•œë‹¤.
- Persistent cookies
  - Expires ì†ì„±ì— ì§€ì •ëœ ë‚ ì§œ í˜¹ì€ Max-age ì†ì„±ì— ì§€ì •ëœ ê¸°ê°„ì´ ì§€ë‚˜ë©´ ì‚­ì œëœë‹¤. 

<br>

### 2) ì„¸ì…˜

> ì‚¬ì´íŠ¸ì™€ íŠ¹ì • ë¸Œë¼ìš°ì € ì‚¬ì´ì˜ ìƒíƒœ(state)ë¥¼ ìœ ì§€ ì‹œí‚¤ëŠ” ê²ƒì´ë‹¤.
>
> (ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ëœ ìƒíƒœ!)

- í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ì ‘ì†í•˜ë©´ ì„œë²„ê°€ íŠ¹ì • session idë¥¼ ë°œê¸‰í•˜ê³ , í´ë¼ì´ì–¸íŠ¸ëŠ” ë°œê¸‰ ë°›ì€ session idë¥¼ ì¿ í‚¤ì— ì €ì¥í•œë‹¤.
  - í´ë¼ì´ì–¸íŠ¸ê°€ ë‹¤ì‹œ ì„œë²„ì— ì ‘ì†í•˜ë©´ ìš”ì²­ê³¼ í•¨ê»˜ session idê°€ ì €ì¥ëœ ì¿ í‚¤ë¥¼ ì„œë²„ì— ì „ë‹¬í•œë‹¤.
  - ì¿ í‚¤ëŠ” ìš”ì²­ ë•Œë§ˆë‹¤ ì„œë²„ì— í•¨ê»˜ ì „ì†¡ë˜ë¯€ë¡œ ì„œë²„ì—ì„œ session idë¥¼ í™•ì¸í•´ ì•Œë§ì€ ë¡œì§ì„ ì²˜ë¦¬í•œë‹¤.
- IDëŠ” ì„¸ì…˜ì„ êµ¬ë³„í•˜ê¸° ìœ„í•´ í•„ìš”í•˜ë©°, ì¿ í‚¤ì—ëŠ” IDë§Œ ì €ì¥í•œë‹¤.

<br>

`ì¿ í‚¤ì™€ ì„¸ì…˜`

ì¥ê³  ë‚´ë¶€ì— sessionidì™€ ê°™ì€ íŠ¹ì • ê°’ì„ ì €ì¥ í•´ì„œ ì¿ í‚¤ìš”ì²­í•˜ëŠ” ì‚¬ëŒê³¼ ë¹„êµí•œë‹¤.

ì €ì¥, ë§Œë£Œì‹œê¸° ê°™ì€ ê²ƒë“¤ì´ DBë‚˜ ë©”ëª¨ë¦¬ì— ì €ì¥ëœë‹¤.  

ì¦‰, ì¿ í‚¤ë‘ ë¹„ìŠ·í•˜ì§€ë§Œ, loginê°™ì€ ê²ƒë“¤ì„ í•  ë•ŒëŠ” ì¿ í‚¤ê°€ ì•„ë‹ˆë¼ ì„¸ì…˜ì— ì €ì¥ì„ í•´ì„œ ê²€ì¦ì„ í•œë²ˆ ë” í•˜ëŠ” ê²ƒì´ë‹¤.

(ì¿ í‚¤ ìì²´ê°€ ì˜¤ì—¼ë„ì–´ ìˆëŠ” ê²½ìš°ê°€ ìˆê¸° ë•Œë¬¸ì— 100%í™•ì‹ ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ë”°ë¼ì„œ ê²€ì¦ì„ ìœ„í•´, ë§Œë£Œê¸°ê°„ì´ë‚˜ í‚¤ë¥¼ ë‹´ì•„ë‘ëŠ” ì„¸ì…˜ì´ í•„ìš”í•œ ê²ƒì´ë‹¤.)

<br>

`Django`

- Djangoì˜ ì„¸ì…˜ì€ ë¯¸ë“¤ì›¨ì–´ë¥¼ í†µí•´ êµ¬í˜„ëœë‹¤.
  - `SessionMiddleware` ìš”ì²­ ì „ë°˜ì— ê±¸ì³ ì„¸ì…˜ì„ ê´€ë¦¬í•œë‹¤.
  - `AuthenticationMiddleware` ì„¸ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìë¥¼ ìš”ì²­ê³¼ ì—°ê²°í•œë‹¤.
- Database- backend sessions ì €ì¥ë°©ì‹ì„ ê¸°ë³¸ ê°’ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.
  - ì„¤ì •ì„ í†µí•´ cached, file-based, cookie-based ë°©ì‹ìœ¼ë¡œ ë³€ê²½ì´ ê°€ëŠ¥í•˜ë‹¤.
- **DjangoëŠ” íŠ¹ì • session idë¥¼ í¬í•¨í•˜ëŠ” ì¿ í‚¤ë¥¼ ì‚¬ìš©í•´ì„œ ê°ê°ì˜ ë¸Œë¼ìš°ì €ì™€ ì‚¬ì´íŠ¸ê°€ ì—°ê²°ëœ ì„¸ì…˜ì„ ì•Œì•„ë‚¸ë‹¤.**
  - **ì„¸ì…˜ ì •ë³´ëŠ” Django DBì˜ django_session í…Œì´ë¸”ì— ì €ì¥ëœë‹¤.**
- ëª¨ë“  ê²ƒì„ ì„¸ì…˜ìœ¼ë¡œ ì‚¬ìš©í•˜ë ¤ê³  í•˜ë©´, ì‚¬ìš©ìê°€ ë§ì„ ëŒ€ ì„œë²„ì— ë¶€í•˜ê°€ ê±¸ë¦´ ìˆ˜ ìˆë‹¤.



> MIDDLEWARE?

HTTP ìš”ì²­ê³¼ ì‘ë‹µ ì²˜ë¦¬ ì¤‘ê°„ì—ì„œ ì‘ë™í•˜ëŠ” ì‹œìŠ¤í…œì´ë‹¤. (hook)

DjangoëŠ” HTTP ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ê±°ì³ í•´ë‹¹ URLì— ë“±ë¡ë˜ì–´ ìˆëŠ” viewë¡œ ì—°ê²°í•´ì£¼ê³ , HTTP ì‘ë‹µ ì—­ì‹œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ê±°ì³ì„œ ë‚´ë³´ë‚¸ë‹¤.

ì£¼ë¡œ ë°ì´í„° ê´€ë¦¬, ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤, ë©”ì‹œì§•, ì¸ì¦ ë° API ê´€ë¦¬ë¥¼ ë‹´ë‹¹í•œë‹¤.

<br>

## 3. ë¡œê·¸ì¸ê³¼ ë¡œê·¸ì•„ì›ƒ

**ë¡œê·¸ì¸ê³¼ ë¡œê·¸ì•„ì›ƒì€ Sessionì„ C**RU**Dí•˜ëŠ” ê²ƒì´ë‹¤.**

ë¡œê·¸ì¸: Django-session tableì— create!

ë¡œê·¸ì•„ì›ƒ: Django-session tableì— delete! 

<br>

### 1) ë¡œê·¸ì¸

> ì„¸ì…˜ create!

<br>

#### (1) AuthenticationForm(request)

https://docs.djangoproject.com/en/4.0/topics/auth/default/#module-django.contrib.auth.forms

- ì‚¬ìš©ìë¥¼ ë¡œê·¸ì¸ í•˜ê¸°ìœ„í•´ ë¹ŒíŠ¸ì¸ í¼ì„ ì‚¬ìš©í•œë‹¤.
- ì²«ë²ˆì§¸ ì¸ìë¡œ requestë¥¼ ì‚¬ìš©í•œë‹¤.  
  - ì¼ë°˜ Formì´ë‹¤. (forms.Formì—ê²Œ ìƒì†ì„ ë°›ëŠ”ë‹¤.)
  - ì¦‰,  ëª¨ë¸ì—ê²Œ ë°›ëŠ” ì •ë³´ê°€ ì—†ê¸° ë•Œë¬¸ì—  requestê°€ í•„ìˆ˜ ë§¤ê°œ ë³€ìˆ˜ì´ë‹¤. 
  - í•˜ìœ„ í´ë˜ìŠ¤ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ form ì¸ìŠ¤í„´ìŠ¤ì— ì €ì¥ëœë‹¤. 
- **DBì— ë°ì´í„°ë¥¼ ì €ì¥í•  í•„ìš”ê°€ ì—†ê¸° ë•Œë¬¸ì—, modelê³¼ ê´€ë ¨ì´ ì—†ëŠ” Formì´ë‹¤.** 
  - **ë‹¨ì§€, login ì •ë³´ë¥¼ ë°›ì•„ì„œ ì¥ê³  sessionì´ë¼ëŠ” DBì— ì €ì¥ì„ í•˜ê¸°ìœ„í•œ ë„êµ¬ì´ë‹¤.**
  - **ì—¬ê¸°ì„œë§Œ` form.get_user() `ë©”ì„œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.** 


<br>

#### (2) login(request, user, backend=None )

- í˜„ì¬ ì„¸ì…˜ì— ì—°ê²°í•˜ë ¤ëŠ” **ì¸ì¦ëœ ì‚¬ìš©ì**ê°€ ìˆëŠ” ê²½ìš° login()í•¨ìˆ˜ê°€ í•„ìš”í•˜ë‹¤.
- DB tableì— sessionì„ ì €ì¥í•˜ê³  ìœ ì €ì—ê²Œ ë°ì´í„°ë¥¼ ë„˜ê²¨ì¤€ë‹¤. 
- HttpRequst ê°ì²´ì™€ User ê°ì²´ê°€ í•„ìš”í•˜ë‹¤.
  - HttpRequst ê°ì²´: ì¿ í‚¤ì— ëŒ€í•œ ë°ì´í„°ë¥¼ ë°›ê¸° ìœ„í•¨ 
  - User ê°ì²´:  `get_user()`ë¥¼ ì‚¬ìš©í•˜ì—¬ ìœ ì €ì—ê²Œ sessionidë¥¼ ë„˜ê²¨ì£¼ê¸° ìœ„í•¨. 

- **ì„¸ì…˜ì— userì˜ IDë¥¼ ì €ì¥í•œë‹¤ (ë¡œê·¸ì¸!)**

<br>

`get_user()`

https://docs.djangoproject.com/en/4.0/topics/auth/default/

- AuthenticationFormì˜ ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œì´ë‹¤.
- user_cacheëŠ” ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œì— Noneìœ¼ë¡œ í• ë‹¹ë˜ë©°, ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µê³¼í–ˆì„ ê²½ìš° **ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µê³¼í•œì‚¬ìš©ì ê°ì²´ë¡œ í• ë‹¹ëœë‹¤.**
- ì¸ìŠ¤í„´ìŠ¤ì˜ ìœ íš¨ì„±ì„ ë¨¼ì € í™•ì¸í•˜ê³ , ì¸ìŠ¤í„´ìŠ¤ê°€ ìœ íš¨í•  ë•Œë§Œ userë¥¼ ì œê³µí•˜ë ¤ëŠ” êµ¬ì¡°ì´ë‹¤.

```python
class AuthenticationForm(forms.Form):
    
    def get_user(self):
        return self.user_cache
```

<br>

#### (3) is_authenticated (ë¡œê·¸ì¸ ì‚¬ìš©ìì— ëŒ€í•œ ì ‘ê·¼ ì œí•œ)

> ë¡œê·¸ì¸ ì‚¬ìš©ìì— ëŒ€í•œ ì—‘ì„¸ìŠ¤ë¥¼ ì œí•œí•œë‹¤.

https://docs.djangoproject.com/en/4.0/ref/contrib/auth/#attributes

- User modelì˜ ì†ì„± ì¤‘ í•˜ë‚˜ì´ë‹¤.
- ëª¨ë“  User ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•´ í•­ìƒ Trueì¸ ì½ê¸° ì „ìš© ì†ì„±ì´ë‹¤.
  - AnonymousUserì— ëŒ€í•´ì„œëŠ” í•­ìƒ Falseì´ë‹¤.
- **ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì•Œ ìˆ˜ ìˆëŠ” ë°©ë²•ìœ¼ë¡œ ì¼ë°˜ì ìœ¼ë¡œ request.userì—ì„œ ì´ ì†ì„±ì„ ì‚¬ìš©í•œë‹¤.**
  - **ë¯¸ë“¤ì›¨ì–´ì˜ `django.contrib.auth.middleware.AuthenticationMiddleware`ë¥¼ í†µê³¼í–ˆëŠ”ì§€ í™•ì¸í•œë‹¤.**
- ë‹¨, ê¶Œí•œê³¼ëŠ” ê´€ë ¨ì´ ì—†ìœ¼ë©° ì‚¬ìš©ìê°€ í™œì„±í™” ìƒíƒœê±°ë‚˜ ìœ íš¨í•œ ì„¸ì…˜ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ë„ í™•ì¸í•˜ì§€ ì•ŠëŠ”ë‹¤.

<br>

`request.user`

- í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¥¼ ë‚˜íƒ€ë‚´ëŠ” AUTH_USER_MODEL ì¸ìŠ¤í„´ìŠ¤ì´ë‹¤.
- ì‚¬ìš©ìê°€ í˜„ì¬ ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ì‚¬ìš©ìëŠ” AnonymousUser ì¸ìŠ¤í„´ìŠ¤ë¡œ ì„¤ì •ëœë‹¤. 
  - ì´ëŠ” is_authenticatedë¡œ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.

<br>

---

**ğŸ™‹â€â™€ï¸ í—·ê°ˆë¦¬ëŠ” ê°œë…**

1. **`Authentication Form`ì˜ `get_user()` ë©”ì„œë“œ**
   - [ê³µì‹ë¬¸ì„œ](https://docs.djangoproject.com/en/4.0/topics/auth/default/)
   - ì¸ì¦ëœ ì‚¬ìš©ì ê°œì²´ë¥¼ ë°˜í™˜ 
   - ë‹¨, ì´ ë©”ì„œë“œëŠ” í¼ ìœ íš¨ì„± ê²€ì‚¬ê°€ ì„±ê³µí•œ í›„ì—ë§Œ í˜¸ì¶œëœë‹¤ (ì¦‰, Authentication Formì—ì„œë§Œ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤. )
2. **`AUTH_USER_MODEL`ì˜ `request.user` ì¸ìŠ¤í„´ìŠ¤**
   - [ê³µì‹ë¬¸ì„œ](https://docs.djangoproject.com/en/4.0/ref/request-response/#attributes-set-by-middleware)
   - í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¥¼ ë‚˜íƒ€ë‚´ëŠ” AUTH_USER_MODEL ì¸ìŠ¤í„´ìŠ¤
3. **`django.contrib.auth`ì˜ `get_user(request)` ë©”ì„œë“œ**
   - [ê³µì‹ë¬¸ì„œ](https://docs.djangoproject.com/en/4.0/ref/contrib/auth/#django-contrib-auth)
   - ì§€ì •ëœ ìš”ì²­ì˜ ì„¸ì…˜ê³¼ ì—°ê²°ëœ ì‚¬ìš©ì ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜
   - ì‚¬ìš©ì ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê²€ìƒ‰í•œ ë‹¤ìŒ ì‚¬ìš©ì ëª¨ë¸ì˜ `get_session_auth_hash()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì„¸ì…˜ì„ í™•ì¸
   - get_user() ë©”ì„œë“œì—ì„œ ì‚¬ìš©ìê°€ ë°˜í™˜ë˜ì§€ ì•ŠëŠ” ê²½ìš° ë˜ëŠ” ì„¸ì…˜ ì¸ì¦ í•´ì‹œê°€ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° AnonymousUser ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜.
   - `from django.contrib.auth import get_user` ë¥¼ í•´ì•¼ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤. 

<br>

**ì¦‰, ëª¨ë‘ ì¸ì¦ëœ(ë¡œê·¸ì¸í•œ) ìœ ì € ê°ì²´ì™€ ê´€ë ¨ì€ ìˆì§€ë§Œ ì‚¬ìš© ë°©ë²•ì€ ë‹¤ë¥´ë‹¤.**

---

<br>

#### (4) login_required decorator (ë¡œê·¸ì¸ ì‚¬ìš©ìì— ëŒ€í•œ ì ‘ê·¼ ì œí•œ)

> ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´, settings.LOGIN_URLì— ì„¤ì •ëœ ë¬¸ìì—´ ê¸°ë°˜ ì ˆëŒ€ ê²½ë¡œë¡œ redirectí•œë‹¤.

- LOGIN_URLì˜ ê¸°ë³¸ ê°’ì€ `/accounts/login/`ì´ë‹¤. 
- ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ì •ìƒì ìœ¼ë¡œ view í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•œë‹¤.
- ì¸ì¦ ì„±ê³µ ì‹œ ì‚¬ìš©ìê°€ redirect ë˜ì–´ì•¼ í•˜ëŠ” ê²½ë¡œëŠ” "next"ë¼ëŠ” ì¿¼ë¦¬ ë¬¸ìì—´ ë§¤ê°œë³€ìˆ˜ì— ì €ì¥ì´ ëœë‹¤.
  - `/accounts/login/?next=/articles/create/`

<br>

`"next" query string parameter`

-  ë¡œê·¸ì¸ì´ ì •ìƒì ìœ¼ë¡œ ì§„í–‰ë˜ë©´ ê¸°ì¡´ì— ìš”ì²­í–ˆë˜ ì£¼ì†Œë¡œ redirect í•˜ê¸° ìœ„í•´ ì£¼ì†Œë¥¼ keepí•œë‹¤.
  - ë‹¨, ë³„ë„ë¡œ ì²˜ë¦¬ í•´ì£¼ì§€ ì•Šìœ¼ë©´ ìš°ë¦¬ê°€ viewì— ì„¤ì •í•œ redirect ê²½ë¡œë¡œ ì´ë™í•˜ê²Œ ëœë‹¤. 

<br>

#### (4) êµ¬í˜„

``` python
# accounts/views.py

from django.views.decorators.http import require_http_methods
from django.contrib.auth.forms import AuthenticationForm
from django.contrib.auth import login as auth_login

@require_http_methods(["GET", "POST"])
def login(request):
    # ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´, redirect!
    if request.user.is_authenticated:
        return redirect('articles:index')
    
    if request.method == "POST":
        # ë‹¨ìˆœ ì¸ì¦ê³¼ì •ì„ ê±°ì¹˜ê³  ì„¸ì…˜ì„ ìƒì„±í•˜ëŠ” ê³¼ì •ì´ë‹¤. 
        form = AuthenticationForm(request, request.POST)
       
        #ë¡œê·¸ì¸ ì§„í–‰ì„ ìœ„í•œ ì‚¬ì „ ì¸ì¦ ì ˆì°¨
        if form.is_valid():
            auth_login(request, form.get_user()) 
            # ë„¥ìŠ¤íŠ¸ íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ê²½ìš° ë¡œê·¸ì¸ í›„ í•´ë‹¹ ê²½ë¡œë¡œ ì´ë™! 
            return redirect(request.GET.get('next') or 'articles:index')
    else:
        form = AuthenticationForm()
    context = {
        'form':form
    }
    return render(request, 'accounts/login.html', context)

```

<br>

```html
<!-- accouts/login.html --> 
{% extends 'base.html' %}

{% block content %}
  <h1>Login</h1>
  <hr>
  <!-- í˜„ì¬ urlë¡œ(next parameterê°€ ìˆëŠ”) ìš”ì²­ì„ ë³´ë‚´ê¸° ìœ„í•´ action ê°’ì„ ë¹„ìš´ë‹¤. --> 
  <form action="" method="POST">
    {% csrf_token %}
    {{ form.as_p }}
    <input type="submit">
  </form>
  <a href="{% url 'articles:index' %}">back</a>
{% endblock content %}


```

<br>

```python
# articles/views.py

from django.views.decorators.http import require_http_methods, require_POST, require_safe
from django.contrib.auth.decorators import login_required

@require_safe
def index(request):
    ...
    
@login_required  
@require_http_methods(['GET', 'POST'])
def create(request):
    ...

@require_safe
def detail(request, pk):
    ...
    
# login_requiredë¥¼ ì‚¬ìš©í•˜ë©´ 405ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.
# ì¡°ê±´ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ì ‘ê·¼ê°€ëŠ¥í•˜ë„ë¡ í•œë‹¤. 
@require_POST
def delete(request, pk):
    if request.user.is_authenticated:
            article = get_object_or_404(Article, pk=pk)
            article.delete()
            return redirect('articles:index')
        
@login_required
@require_http_methods(['GET', 'POST'])
def update(request, pk):
    ...
    
```

- 405ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ì´ìœ 
  - ë¡œê·¸ì¸ ì´í›„ "next" ë§¤ê°œë³€ìˆ˜ë¥¼ ë”°ë¼ í•´ë‹¹ í•¨ìˆ˜ë¡œ ë‹¤ì‹œ redirectë˜ëŠ”ë°, ì´ ë•Œ @require_POST ë•Œë¬¸ì— 405ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.
  - redirectê³¼ì •ì—ì„œ POSTë°ì´í„°ë¥¼ ì†ì‹¤í•˜ê¸° ë•Œë¬¸ì— GET ë°©ì‹ìœ¼ë¡œ ìš”ì²­ëœë‹¤. ã…  
  - ë¹„ ë¡œê·¸ì¸ ìƒíƒœë¡œ ê¸€ ì‚­ì œ ìš”ì²­(POST) => ë¡œê·¸ì¸ ê²€ì¦ í›„  ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ => ë¡œê·¸ì¸ ìš”ì²­(POST) => ë¡œê·¸ì¸ ì„±ê³µ ë° next ê²½ë¡œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸(GET) 

<br>

### 2) ë¡œê·¸ì•„ì›ƒ

>  ì„¸ì…˜ Delete!

#### (1) logout(request)

- HttpRequest ê°ì²´ë¥¼ ì¸ìë¡œ ë°›ê³  ë°˜í™˜ ê°’ì´ ì—†ë‹¤.
- ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° **ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¤ì§€ ì•ŠëŠ”ë‹¤.**
- í˜„ì¬ ìš”ì²­ì— ëŒ€í•œ session dataë¥¼ DBì—ì„œ ì™„ì „íˆ ì‚­ì œí•˜ê³ , í´ë¼ì´ì–¸íŠ¸ ì¿ í‚¤ì—ì„œë„ sessionidê°€ ì‚­ì œëœë‹¤.
- ë‹¤ë¥¸ ì‚¬ëŒì´ ë™ì¼í•œ ì›¹ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•˜ê³ , ì´ì „ ì‚¬ìš©ìì˜ ì„¸ì…˜ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤ í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•¨ì´ë‹¤. 

<br>

#### (2) êµ¬í˜„

```python
from django.views.decorators.http import require_POST
from django.contrib.auth import logout as auth_logout

@require_POST
def logout(request):
    if request.user.is_authenticated:
        auth_logout(request)
    return redirect('articles:index')

```

<br>

### 3) templates

```html
<!-- base.html --> 

    <div class="container">
      {% if request.user.is_authenticated %} 
        <h3>
          Hello,{{ user }}
        </h3>
        <form action="{% url 'accounts:logout' %}" method="POST">
          {% csrf_token %}
          <input type="submit" value="Logout">
      {% else %}
        <a href="{% url 'accounts:login' %}">Login</a>
      {% endif %}
      {% block content %}{% endblock content %}
    </div>
```

- `{{ user }}`ë¡œ í˜„ì¬ ë¡œê·¸ì¸ ë˜ì–´ìˆëŠ” ìœ ì € ì •ë³´ë¥¼ ì¶œë ¥í•œë‹¤.
- ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ì§€ ì•Šì•˜ëŠ”ë° ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëŠ” ê±¸ê¹Œ..?  

<br>

#### (1) context processors

- í…œí”Œë¦¿ì´ ë Œë”ë§ ë  ë•Œ ìë™ìœ¼ë¡œ í˜¸ì¶œ ê°€ëŠ¥í•œ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° ëª©ë¡
- ì‘ì„±ëœ í”„ë¡œì„¸ì„œëŠ” RequestContextì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜ë¡œ í¬í•¨ëœë‹¤. 

```python
# settings.py

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates',],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]
```

<br>

`Users`

- í…œí”Œë¦¿ RequestContextë¥¼ ë Œë”ë§í•  ë•Œ, í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¥¼ ë‚˜íƒ€ë‚´ëŠ” auth.User ì¸ìŠ¤í„´ìŠ¤ì´ë‹¤.
  - (í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°ëŠ” AnonymousUser ì¸ìŠ¤í„´ìŠ¤)
- í…œí”Œë¦¿ ë³€ìˆ˜ `{{ user }}`ì— ì €ì¥ëœë‹¤.

<br>

## 3. íšŒì› ê°€ì…, íƒˆí‡´, ìˆ˜ì •

**Userë¥¼ CRUD í•˜ëŠ” ê²ƒì´ë‹¤!**

<br>

### 1) íšŒì› ê°€ì…

#### (1) UserCreationForm

[ê³µì‹ë¬¸ì„œ](https://github.com/django/django/blob/main/django/contrib/auth/forms.py#L104)

> ì£¼ì–´ì§„ usernameê³¼ passwordë¡œ ê¶Œí•œì´ ì—†ëŠ” ìƒˆ userë¥¼ ìƒì„±í•˜ëŠ” ModelForm

3ê°œì˜ í•„ë“œë¥¼ ê°€ì§„ë‹¤.

- username (from the user model)
- password1
- password2

ë¹„ë°€ë²ˆí˜¸ fieldê°€ 2ê°œì¸ ì´ìœ ëŠ” 2ê°œê°€ ê°™ì€ì§€ ê²€ì¦í•˜ê¸° ìœ„í•´ì„œ ë…ë¦½ì ìœ¼ë¡œ 2ê°œ í•„ë“œë¥¼ ë§Œë“¤ì—ˆë‹¤ê³  ë³´ë©´ ëœë‹¤.

<br>

#### (2) êµ¬í˜„

```python
#accouts/views.py

from django.views.decorators.http import require_http_methods, require_POST
from django.contrib.auth.forms import UserCreationForm

@require_http_methods(["GET", "POST"])
def signup(request):
    if request.user.is_authenticated:
        return redirect('articles:index')
        
    if request.method == "POST":
        # ModelForm
        form = UserCreationForm(data=request.POST)
        if form.is_valid():
            #  saveëœ ê°ì²´ë¡œ ueser ë§¤ê°œë³€ìˆ˜ë¥¼ ì „ë‹¬í•œë‹¤.  
            user = form.save()
            auth_login(request,user)  # íšŒì›ê°€ì… í›„ ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ì„ ì§„í–‰í•œë‹¤. 
            return redirect('articles:index')
    else:
        form = UserCreationForm()
    context = {
        'form':form
    }
    return render(request, 'accounts/signup.html', context)
```



`UserCreationFormì˜ save()`

```python
def save(self, commit=True):
     user = super().save(commit=False)
     user.set_password(self.cleaned_data["password1"])
     if commit:
            user.save()
     return user
```

=> user ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

<br>

### 2) íšŒì› íƒˆí‡´

> DBì—ì„œ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ëŠ” ê²ƒê³¼ ê°™ë‹¤

```python
#accouts/views.py

from django.views.decorators.http import require_POST

@require_POST
def delete(request):
    if request.user.is_authenticated:
        # ë°˜ë“œì‹œ íšŒì› íƒˆí‡´í›„, ë¡œê·¸ì•„ì›ƒì„ í•´ì•¼í•œë‹¤.
        # íšŒì›ì •ë³´ê°€ ì—†ì–´ì„œ íšŒì› íƒˆí‡´ê°€ ë˜ì§€ ì•ŠëŠ”ë‹¤. 
        request.user.delete()
        auth_logout(request)
    return redirect('articles:index')
    
```

<br>

### 3) íšŒì› ì •ë³´ ìˆ˜ì •

#### (1) UserChangeForm

> ì‚¬ìš©ìì˜ ì •ë³´ ë° ê¶Œí•œì„ ë³€ê²½í•˜ê¸° ìœ„í•´ admin ì¸í„°í˜ì´ìŠ¤ì—ì„œ ì‚¬ìš©ë˜ëŠ” ModelFormì´ë‹¤.

- ì¼ë°˜ ì‚¬ìš©ìê°€ ì ‘ê·¼í•´ì„œëŠ” ì•ˆë  fieldê¹Œì§€ ë…¸ì¶œí•˜ê¸° ë•Œë¬¸ì— ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ìœ„í—˜í•˜ë‹¤.
- ê·¸ ê²°ê³¼ UserChangeFormì„ ìƒì†ë°›ì•„ ìƒˆë¡œìš´ Formì„ ë§Œë“ ë‹¤.

<br>

```python
# accounts/forms.py

from django.contrib.auth.forms import UserChangeForm
from django.contrib.auth.models import User
from django.contrib.auth import get_user_model 

class CustonUserChangeForm(UserChangeForm):
    class Meta:
        # model = User
        model = get_user_model()
        fields = ('username', 'last_name', 'first_name',)
```

- model ì†ì„± :  **User ëª¨ë¸ì„ ì§ì ‘ ì‚¬ìš©í•˜ì§€ì•Šê³  `get_user_model()`ì„ ì‚¬ìš©í•œë‹¤.** 
  - get_user_modelì€ í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ User í´ë˜ìŠ¤ë¥¼ ë°˜í™˜í•œë‹¤. (í™œì„±í™”ëœ ì‚¬ìš©ì ëª¨ë¸)
  - ì¼ë°˜ì ìœ¼ë¡œ UserëŠ” ì¬ ì •ì˜(ì•„ë˜ì—ì„œ ì„¤ëª…) í•˜ëŠ” ê²½ìš°ê°€ ë§ì€ë°,  `get_user_model()`ì€
    - ì¬ ì •ì˜ í•˜ì§€ ì•Šì•˜ì„ ë•ŒëŠ” Userí´ë˜ìŠ¤
    - ì¬ ì •ì˜í–ˆì„ ë•ŒëŠ” ìƒˆë¡­ê²Œ ë§Œë“  Userë¥¼ ì¡ëŠ”ë‹¤. 
    - ì¦‰, ìœ ì—°í•œ ëŒ€ì²˜ë¥¼ ìœ„í•´ `get_user_model()`ì„ ì‚¬ìš©í•œë‹¤. 

- fields ì†ì„±: User í´ë˜ìŠ¤ < abstractUser í´ë˜ìŠ¤ <  AbstractBaseUser í´ë˜ìŠ¤

  - ì•„ë˜ì—ì„œ ë¶€ê°€ ì„¤ëª…í•˜ê² ì§€ë§Œ, Userí´ë˜ìŠ¤ëŠ” ê¸°ëŠ¥ì´ ì—†ëŠ” ê¹¡í†µ í´ë˜ìŠ¤ì´ë‹¤.

  - ìƒì†ì„ ë°›ëŠ” AbstractUser í´ë˜ìŠ¤ , AbstractBaseUser í´ë˜ìŠ¤ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” fieldë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

  - | **AbstractUser**     | **username, first_name, last_name, email, is_staff, is_active, date_joined** |
    | -------------------- | ------------------------------------------------------------ |
    | **AbstractBaseUser** | **password, last_login**                                     |
    | **PermissionsMixin** | **is_superuser**                                             |

<br>

---

`User ì¬ ì •ì˜`

> [ê³µì‹ë¬¸ì„œ](https://docs.djangoproject.com/en/4.0/topics/auth/default/#user-objects)
>
> [ë§í¬](https://han-py.tistory.com/353)

ìš°ë¦¬ëŠ” ì›¹ì„ ë§Œë“¤ ë•Œ íšŒì›ê´€ë¦¬ë¥¼ ìœ„í•´ userë¥¼ DBì— ë„£ì–´ì•¼ í•œë‹¤. ì´ ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ Userë¥¼ ì¥ê³ ê°€ ì œê³µì„ í•œë‹¤. 

```python
class User(AbsractUser):
    
    class Meta(AbstractUser.Meta):
        swappable = 'AUTH_USER_MODEL' # AUTH_USER_MODELì´ë¼ëŠ” ì†ì„±ì— ì˜í•´ì„œ ë³€í•  ìˆ˜ ìˆë‹¤. 
```

- Userì˜ ì†ì„±ì€ Userê°€ ìƒì†ë°›ëŠ” `AbsractUser`í´ë˜ìŠ¤ì— ìˆë‹¤.

- ì¦‰, Userìì²´ëŠ” ê¸°ëŠ¥ì´ ì—†ê³  Django ë‚´ë¶€ì— ì„¸íŒ…ëœ ê°’ì´ë¼ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

- **ê·¸ ê²°ê³¼, User ì¬ì •ì˜ê°€ í•„ìš”í•˜ë‹¤.** 

  - ```python
    # accouts/models.py
    
    from django.db import models
    from django.contrib.auth.models import AbstractUser
    # Create your models here.
    
    class User(AbstractUser):
        pass
    ```

  - ```python
    # settings.py
    
    # accountsì˜ appì˜ models.pyì—ì„œ ë‚´ê°€ ì„¤ì •í•œ Userë¥¼ ì‚¬ìš©í•˜ê² ë‹¤ê³  ì„¤ì •í•œë‹¤. 
    AUTH_USER_MODEL = 'accounts.User'
    ```

<br>

**ì¦‰, ì¥ê³  ë‚´ë¶€ì˜ Userë¡œ í•  ìˆ˜ ìˆëŠ” ê²ƒì€ í•œê³„ê°€ ìˆê¸° ë•Œë¬¸ì— ë‚´ê°€ Userë¥¼ models.pyì— ë§Œë“ ë‹¤.**

**ê·¸ë¦¬ê³  settings.pyì—ì„œ AUTH_USER_MODEL ì„¤ì •ì„ í•˜ì—¬ ì¥ê³  ë‚´ë¶€ì˜ UserëŒ€ì‹  ë‚´ê°€ ë§Œë“  Userë¥¼ ì‚¬ìš©í•œë‹¤.** 

**(`get_user_model()`ì„ ì´ìš©í•´ì„œ í´ë˜ìŠ¤ë¡œ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©í•œë‹¤. )**

---

<br>

#### (2) êµ¬í˜„

```python
# accounts/views.py

from .forms import CustonUserChangeForm
from django.contrib.auth.decorators import login_required
from django.views.decorators.http import require_http_methods

@login_required
@require_http_methods(['GET', 'POST'])
def update(request):
    if request.method == "POST":
        form = CustonUserChangeForm(data=request.POST, instance=request.user)
        if form.is_valid:
            # ìƒì†ë°›ëŠ” UserëŠ” ëª¨ë¸í¼ì´ê¸° ë•Œë¬¸ì— save()ê°€ ê°€ëŠ¥í•˜ë‹¤. 
            form.save()
            return redirect('articles:index')
    else:
        form = CustonUserChangeForm(instance=request.user)
    context = {
        'form': form 
    }
    return render(request, 'accounts/update.html', context)
```

<br>

### 4) ë¹„ë°€ ë²ˆí˜¸ ìˆ˜ì •

[djangoì˜ ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • ë¡œì§ ](https://docs.djangoproject.com/en/4.0/topics/auth/default/#changing-passwords)

 #### (1)PasswordChangeForm

> ì‚¬ìš©ìê°€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” Formì´ë‹¤.
>
> [ê³µì‹ë¬¸ì„œ](https://docs.djangoproject.com/en/4.0/topics/auth/default/#django.contrib.auth.forms.PasswordChangeForm)

- ì´ì „ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

 ```python
 class PasswordChangeForm(SetPasswordForm):
     """
     A form that lets a user change their password by entering their old
     password.
     """
     error_messages = {
         **SetPasswordForm.error_messages,
         'password_incorrect': _("Your old password was entered incorrectly. Please enter it again."),
     }
     old_password = forms.CharField(
         label=_("Old password"),
         strip=False,
         widget=forms.PasswordInput(attrs={'autocomplete': 'current-password', 'autofocus': True}),
     )
 
     field_order = ['old_password', 'new_password1', 'new_password2']
 
 ```

- 3ê°œì˜ í•„ë“œê°€ ì¡´ì¬í•œë‹¤.
  - old_password
  -  new_password1
  - new_password2

- SetPasswordFormì˜ ìƒì†ì„ ë°›ëŠ” ì„œë¸Œ í´ë˜ìŠ¤ì´ë‹¤.
  - SetPasswordFormì€ forms.Formì—ê²Œ ìƒì†ì„ ë°›ëŠ”ë‹¤. ì¦‰,  **ëª¨ë¸í¼ì€ ì•„ë‹Œ ì¼ë°˜ í¼ì´ë‹¤.**

<br>

#### (2) update_session_auth_hash(request, user)

- í˜„ì¬ ìš”ì²­ê³¼ ìƒˆ session hashê°€ íŒŒìƒ ë  ì—…ë°ì´íŠ¸ ëœ ì‚¬ìš©ì ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ê³ , session hasgë¥¼ ì ì ˆí•˜ê²Œ ì—…ë°ì´íŠ¸í•œë‹¤.
- **ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ë©´ ê¸°ì¡´ ì„¸ì…˜ê³¼ì˜ íšŒì› ì¸ì¦ ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•Šê²Œ ë˜ì–´ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì´ë‹¤.**
- ì•”í˜¸ê°€ ë³€ê²½ë˜ì–´ë„ ë¡œê·¸ì•„ì›ƒë˜ì§€ ì•Šë„ë¡ ìƒˆë¡œìš´ password hashë¡œ sessionì„ ì—…ë°ì´íŠ¸í•œë‹¤. 

<br>

#### (3) êµ¬í˜„

```python
# accounts/views.py
from django.contrib.auth import update_session_auth_hash
from django.contrib.auth.forms import PasswordChangeForm
from django.views.decorators.http import require_http_methods
from django.contrib.auth.decorators import login_required

@login_required
@require_http_methods(['GET', 'POST'])
def change_password(request):
    if request.method == 'POST':
        # ëª¨ë¸ í¼ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— userê´€ë ¨ ì •ë³´ê°€ í•„ìš”í•˜ë‹¤.  
        form = PasswordChangeForm(user=request.user, data=request.POST)
        if form.is_valid():
            member = form.save()
            # ì„¸ì…˜ì„ ìœ ì§€ ì‹œí‚¨ë‹¤. 
            # update_session_auth_hash(request, form.user)
            update_session_auth_hash(request, member)
            return redirect('articles:index')
    else:
        form = PasswordChangeForm(request.user)
    context = {
        'form': form,
    }
    return render(request, 'accounts/change_password.html', context)
```



<br>

## 4. ìš”ì•½ 

`ë¡œê·¸ì¸`

| í‚¤ì›Œë“œ                                 | ì„¤ëª…                                                         |
| -------------------------------------- | ------------------------------------------------------------ |
| `AuthenticationForm(request)`          | forms.Formì˜ ì„œë¸Œ í´ë˜ìŠ¤<br /> modelformì´ ì•„ë‹ˆë‹¤. ê·¸ ê²°ê³¼, ëª¨ë¸ì—ê²Œ ë°›ëŠ” ì •ë³´ê°€ ì—†ë‹¤.<br />ìƒˆë¡œìš´ ì •ë³´ë¥¼ ë” ë„˜ê²¨ì¤˜ì•¼ í•˜ê¸° ë•Œë¬¸ì— requestë¥¼ ë°˜ë“œì‹œ í¬í•¨ ì‹œì¼œ ì¤˜ì•¼í•œë‹¤ |
| `auth_login(request, form.get_user())` | ëª¨ë¸ê³¼ ê´€ë ¨ì´ ì—†ê³  ë¡œê·¸ì¸ì„ ìœ„í•œ í•¨ìˆ˜ê°€ ì¡´ì¬í•œë‹¤.<br />`request`: ì¿ í‚¤ì™€ ì„¸ì…˜ ì¤‘ì— ì¿ í‚¤ëŠ” ìš”ì²­ ê°ì²´ì— ë‹´ê²¨ìˆê¸° ë•Œë¬¸ì— ì¿ í‚¤ë¥¼ ë°›ê¸°ìœ„í•´ì„œëŠ” requestëŠ” í•„ìˆ˜!<br />`form.get_user()`: formì— ìˆëŠ” userì •ë³´ì´ë‹¤. <br />(DB tableì— ì„¸ì…˜ì„ ì €ì¥í•˜ê³  ì¿ í‚¤ì— ë‹´ì•„ì„œ ì‚¬ìš©ìì—ê²Œ ë„˜ê²¨ì¤€ë‹¤.) |



`íšŒì› ê°€ì…`

| í‚¤ì›Œë“œ                     | ì„¤ëª…                                                         |
| -------------------------- | ------------------------------------------------------------ |
| ` UserCreationForm`        | forms.ModelFormì˜ ì„œë¸Œ í´ë˜ìŠ¤<br />username (from the user model), password1, password2 ì´ 3ê°œì˜ í•„ë“œë¥¼ ê°€ì§€ê³  ìˆë‹¤. |
| `user = form.save()`       | form.save()ëŠ” ìœ ì €ë¥¼ ë°˜í™˜í•œë‹¤.                               |
| `auth_login(request,user)` | íšŒì› ê°€ì… í›„ ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ë˜ëŠ”ê²Œ ìì—°ìŠ¤ëŸ¬ìš´ ë¡œì§ì´ë‹¤.   |

<br>

`íšŒì› ì •ë³´ ìˆ˜ì •`

| í‚¤ì›Œë“œ                                        | ì„¤ëª…                                                         |
| --------------------------------------------- | ------------------------------------------------------------ |
| `CustonUserChangeForm(instance=request.user)` | UserChangeForm, AbstractUser, AbstractBaseUser í´ë˜ìŠ¤ì˜ ì„œë¸Œ í´ë˜ìŠ¤ë¡œ ëª¨ë¸í¼ì´ë‹¤.<br />formì„ ì •ì˜í•  ë•Œ, <br />modelsì€ ìœ ì—°í•œ ëŒ€ì²˜ë¥¼ ìœ„í•´ get_user_model()ë¥¼ ì‚¬ìš©í•œë‹¤. <br />fieldsëŠ” ìœ„ì˜ í´ë˜ìŠ¤ë“¤ì˜ ì†ì„±ì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.<br /><br />updateì´ê¸° ë•Œë¬¸ì— instance ë§¤ê°œë³€ìˆ˜ê°€ í•„ìš”í•˜ë‹¤. |
| `form.save()`                                 | ëª¨ë¸í¼!                                                      |

<br>

`ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì •`

| í‚¤ì›Œë“œ                                         | ì„¤ëª…                                                         |
| ---------------------------------------------- | ------------------------------------------------------------ |
| `PasswordChangeForm(request.user)`             | SetPasswordFormì˜ ì„œë¸Œ í´ë˜ìŠ¤ë¡œ ì¼ë°˜ formì´ë‹¤.<br />ë§¤ê°œë³€ìˆ˜userëŠ” í•„ìˆ˜ ì¸ìì´ë‹¤. |
| `update_session_auth_hash(request, form.user)` | ì„¸ì…˜ì„ ìœ ì§€ì‹œí‚¤ê¸° ìœ„í•´ í•„ìš”í•˜ë‹¤.                             |
| `form.save()`                                  | ëª¨ë¸ í¼ì´ ì•„ë‹˜ì—ë„ save()ë©”ì„œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì´ìœ ëŠ” SetPasswordFormì—ì„œ ë”°ë¡œ ì •ì˜ë¥¼ í–ˆê¸° ë•Œë¬¸ì´ë‹¤. |

<br>
