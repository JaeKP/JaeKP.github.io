<!DOCTYPE html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="MongoDB-Read-성능-향상시키기" /><meta name="author" content="박재경" /><meta property="og:locale" content="ko" /><meta name="description" content="강의 링크" /><meta property="og:description" content="강의 링크" /><link rel="canonical" href="https://jaekp.github.io/posts/mogodb03/" /><meta property="og:url" content="https://jaekp.github.io/posts/mogodb03/" /><meta property="og:site_name" content="Hello, World!" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-02-06T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="MongoDB-Read-성능-향상시키기" /><meta name="google-site-verification" content="LP7vGYSUszERSVMH1MoT4NXRTCcbUaUtfFm_pOYcoQ4" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"박재경"},"dateModified":"2023-02-06T00:00:00+09:00","datePublished":"2023-02-06T00:00:00+09:00","description":"강의 링크","headline":"MongoDB-Read-성능-향상시키기","mainEntityOfPage":{"@type":"WebPage","@id":"https://jaekp.github.io/posts/mogodb03/"},"url":"https://jaekp.github.io/posts/mogodb03/"}</script><title>MongoDB-Read-성능-향상시키기 | Hello, World!</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hello, World!"><meta name="application-name" content="Hello, World!"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/mococo.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hello, World!</a></div><div class="site-subtitle font-italic">난 재경쓰!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/JaeKP" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jkp71192','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>MongoDB-Read-성능-향상시키기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>MongoDB-Read-성능-향상시키기</h1><div class="post-meta text-muted"><div> By <em> 박재경 </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1675609200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-02-06 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2890 words"> <em>16 min</em> read</span></div></div></div><div class="post-content"><p><a href="https://www.inflearn.com/course/%EB%AA%BD%EA%B3%A0%EB%94%94%EB%B9%84-%EA%B8%B0%EC%B4%88-%EC%8B%A4%EB%AC%B4#">강의 링크</a></p><p><br /></p><p>Read는 퍼포먼스에 많은 영향을 미친다. 서로 연결되어 있는 데이터를 가공, 조합해야 하기 때문에 DB 설계를 어떻게 하느냐 따라 성능이 달라진다.</p><p>만약 다음과 같은 콜렉션을 가진 데이터베이스가 있다고 가정해보자.</p><div class="table-wrapper"><table><thead><tr><th>콜렉션<th>관계<tbody><tr><td>User<td>1<tr><td>Blog<td>N</table></div><p><br /></p><div class="table-wrapper"><table><thead><tr><th>콜렉션<th>관계<tbody><tr><td>User<td>N<tr><td>Blog<td>N<tr><td>Comment<td>1</table></div><p><br /></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="err">id:</span><span class="w"> </span><span class="s2">"Blogid"</span><span class="p">,</span><span class="w">
    </span><span class="err">title:</span><span class="w"> </span><span class="s2">"BlogTitle"</span><span class="p">,</span><span class="w">
    </span><span class="err">content:</span><span class="w"> </span><span class="s2">"BlogContent"</span><span class="p">,</span><span class="w">
    </span><span class="err">user:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="err">id:</span><span class="w"> </span><span class="s2">"userId"</span><span class="p">,</span><span class="w">
        </span><span class="err">username:</span><span class="w"> </span><span class="s2">"username"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">comments:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="err">content:</span><span class="w"> </span><span class="s2">"content"</span><span class="p">,</span><span class="w">
            </span><span class="err">user:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="err">id:</span><span class="w"> </span><span class="s2">"userId"</span><span class="p">,</span><span class="w">
                </span><span class="err">username:</span><span class="w"> </span><span class="s2">"username"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>일반적으로 프론트는 위와 같은 데이터를 원한다. 게시글에 대한 정보를 보낼 때, 해당 게시글과 관련된 댓글과 유저에 대한 정보도 전달해야 하는 것이다.</p><p>그렇다면, 이러한 데이터 구조를 만드는 방법에 대해서 알아보자.</p><p><br /></p><h1 id="1-데이터를-직접-요청">1. 데이터를 직접 요청</h1><blockquote class="prompt-tip"><div><p>매번 필요한 정보를 요청하여 데이터를 client에서 가공한다.</p><p>이는, 클라이언트가 백엔드에 요청하는 호출은 최소화 해야 하기 때문에 비효율적인 방법이다.</p></div></blockquote><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="c1">// client.js</span>

<span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">axios</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">URI</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost:3000</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">BLOG_URI</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">URI</span><span class="p">}</span><span class="s2">/blog`</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">USER_URI</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">URI</span><span class="p">}</span><span class="s2">/user`</span><span class="p">;</span>


<span class="kd">const</span> <span class="nx">test</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="dl">"</span><span class="s2">loading time: </span><span class="dl">"</span><span class="p">);</span>
<span class="kd">let</span> <span class="p">{</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="nx">blogs</span> <span class="p">},</span>
<span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">BLOG_URI</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

<span class="nx">blogs</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
  <span class="nx">blogs</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">blog</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">[</span><span class="nx">res1</span><span class="p">,</span> <span class="nx">res2</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
      <span class="c1">// 게시글 작성 유저 정보 요청</span>
      <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">USER_URI</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">blog</span><span class="p">.</span><span class="nx">user</span><span class="p">}</span><span class="s2">`</span><span class="p">),</span>
        
      <span class="c1">// 게시글 정보 요청</span>
      <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">BLOG_URI</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">blog</span><span class="p">.</span><span class="nx">_id</span><span class="p">}</span><span class="s2">/comment`</span><span class="p">),</span>
    <span class="p">]);</span>
    <span class="nx">blog</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">res1</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
      
    <span class="c1">// 게시글 댓글, 댓글 작성 유저 정보 요청</span>
    <span class="nx">blog</span><span class="p">.</span><span class="nx">comments</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
      <span class="nx">res2</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">comment</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="p">{</span>
          <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="nx">user</span> <span class="p">},</span>
        <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">USER_URI</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">comment</span><span class="p">.</span><span class="nx">user</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="nx">comment</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">comment</span><span class="p">;</span>
      <span class="p">})</span>
    <span class="p">);</span>

    <span class="k">return</span> <span class="nx">blog</span><span class="p">;</span>
  <span class="p">})</span>
<span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">(</span><span class="nx">blogs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{</span> <span class="na">depth</span><span class="p">:</span> <span class="mi">10</span> <span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">timeEnd</span><span class="p">(</span><span class="dl">"</span><span class="s2">loading time: </span><span class="dl">"</span><span class="p">);</span> 
<span class="p">};</span> 
</pre></table></code></div></div><ul><li>데이터가 많아지면 많아 질 수록 호출 수가 증가하기 때문에 데이터를 가공하고 합치는데 시간이 너무 걸린다.<li>클라이언트가 백엔드에서 게시글 목록을 요청할 때 각 게시글에 대한 작성자 정보, 댓글, 댓글의 작성자 정보를 따로 요청하게 되는데 게시글의 개수가 N개일 경우, N+3 번의 요청이 발생하는 것이다.</ul><p>이러한 현상을 <strong>N+1 Problem</strong>라고 한다. 클라이언트가 하나의 리소스에 대한 정보를 요청할 때, 관련된 다른 리소스를 하나씩 요청하는 경우에 발생한다.</p><p>이를 방지하기 위해서는 <strong>백엔드에서 한 번에 필요한 모든 데이터를 포함하여 클라이언트에 응답</strong>하는 것이 좋다. 또한, 클라이언트에서 한 번에 필요한 모든 데이터를 요청하는 것도 좋은 방법이다.</p><p><br /></p><h1 id="2-populate">2. Populate()</h1><blockquote class="prompt-tip"><div><p><code class="language-plaintext highlighter-rouge">populate()</code> 메서드는 한 문서에서 다른 문서로의 참조 관계를 처리할 때 사용하며</p><p>참조 관계를 가지는 두 문서의 <code class="language-plaintext highlighter-rouge">_id</code>값을 기준으로 연결한다.</p></div></blockquote><p><code class="language-plaintext highlighter-rouge">populage()</code>메서드를 사용하면 참조 관계를 가진 데이터들을 한 번에 클라이언트에게 보내는 데 용이하다.</p><p><br /></p><h2 id="1-schema-수정"><span class="mr-2">1) Schema 수정</span><a href="#1-schema-수정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>먼저 BlogSchema를 통해 comments에 접근하기 위해 가상 keys를 BlogSchema에 추가해야 한다.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="c1">// src/models/Blog.js</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">Schema</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">Types</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">mongoose</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">CommentSchema</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./Comment.js</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">BlogSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">(</span>
  <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">content</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">isLive</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">Boolean</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">user</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">ref</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span> <span class="p">},</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="na">timestamps</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// 가상의 key를 만들어 comments에 접근한다. </span>
<span class="c1">// commentSchema의 blog 필드를 통해 연결되어 있어 가능하다. (역참조를 위한 설정)</span>
<span class="nx">BlogSchema</span><span class="p">.</span><span class="nx">virtual</span><span class="p">(</span><span class="dl">"</span><span class="s2">comments</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">ref</span><span class="p">:</span> <span class="dl">"</span><span class="s2">comment</span><span class="dl">"</span><span class="p">,</span>       <span class="c1">// 어떤 모델인가</span>
  <span class="na">localField</span><span class="p">:</span> <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span><span class="p">,</span>    <span class="c1">// 참고해야 하는 필드는 무엇인가</span>
  <span class="na">foreignField</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blog</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// 어떻게 연결되어있는가</span>
<span class="p">});</span>

<span class="nx">BlogSchema</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">toObject</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">virtuals</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">BlogSchema</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">toJSON</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">virtuals</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>

<span class="kd">const</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="dl">"</span><span class="s2">blog</span><span class="dl">"</span><span class="p">,</span> <span class="nx">BlogSchema</span><span class="p">);</span>
<span class="k">export</span> <span class="k">default</span> <span class="nx">Blog</span><span class="p">;</span>

</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">vitrual()</code>은 데이터베이스에 저장되지 않은, 스키마에 정의된 프로퍼티의 가상 필드를 생성하는 메서드이다.<ul><li>예를 들어, 사용자 도큐먼트에서 이름과 패스워드 필드를 갖는데, 사용자의 전체 이름을 구성하는 가상 필드를 생성할 수 있다.<li>가상 필드는 데이터베이스에 저장되지 않지만, 사용자 문서에서 사용 가능한 프로퍼티이다.</ul><li><code class="language-plaintext highlighter-rouge">virtual()</code>메서드를 사용하면 <strong>역참조 관계를 모델에서 정의할 수 있다.</strong><ul><li><strong>가상 속성을 추가하고 이 가상 속성에서 지정된 경로의 문서를 참조</strong> 할 수 있다.</ul></ul><p><br /></p><h2 id="2-api-수정"><span class="mr-2">2) API 수정</span><a href="#2-api-수정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1">// src/routes/Blogroute.js</span>

<span class="nx">blogRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// 연결시킬 데이터를 populate를 사용하여 참조해준다.</span>
    <span class="c1">// {path: "user}: 게시글 작성 유저</span>
    <span class="c1">// {path: "comments", populate: {path: "user"}}: 댓글, 댓글 작성 유저</span>
    <span class="kd">const</span> <span class="nx">blogs</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Blog</span><span class="p">.</span><span class="nx">find</span><span class="p">({})</span>
      <span class="p">.</span><span class="nx">populate</span><span class="p">([{</span> <span class="na">path</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="dl">"</span><span class="s2">comments</span><span class="dl">"</span><span class="p">,</span> <span class="na">populate</span><span class="p">:</span> <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}]);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">blogs</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><p>이렇게 <code class="language-plaintext highlighter-rouge">populate()</code>를 활용해 참조한 데이터를 탐색하여 한번에 클라이언트에게 전달할 수 있다.</p><p>확실히, 클라이언트와 백엔드간의 통신의 횟수는 1번으로 줄였지<strong>만 참조한 데이터를 탐색하는 데 시간이 걸리</strong>기 때문에 다른 방법이 좀 더 효율이 좋을 수 있다.</p><p><br /></p><h1 id="3-nesting-문서-내장">3. Nesting (문서 내장)</h1><blockquote class="prompt-tip"><div><p>Nesting은 하나의 문서 안에 다른 문서를 포함하는 과정을 말한다.</p><p>포함된 문서는 부모 문서의 필드로 저장된다.</p></div></blockquote><p>Nesting을 통해 <strong>관련 데이터를 함께 저장</strong>하여, 관련 데이터가 별도의 컬렉션에 저장되어 있는 경우에 비해 검색하고 조작하는 것이 더 효율적인 방법이다.</p><p>특히 몽고 DB는 수평적인 확장이 굉장히 용이 하기 때문에 데이터 용량 자체가 크더라도 괜찮다. (그래도 16mb 이상이 되어서는 안된다.)</p><ul><li>관련 데이터가 하나의 문서에 함께 저장되어 데이터의 일관성이 향상된다.<li>별도의 컬렉션에 대한 여러 읽기와 쓰기 작업이 줄어들어 성능이 향상도니다.<li>관련 데이터가 하나의 문서에 저장되어 하나의 단위로 조작하기 쉽다.</ul><p><br /></p><h2 id="1-schema-수정-1"><span class="mr-2">1) Schema 수정</span><a href="#1-schema-수정-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="c1">// src/models/commentRoute.js</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">Schema</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">Types</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">mongoose</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">CommentSchema</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./Comment.js</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">// 관계형 DB 만들기</span>
<span class="kd">const</span> <span class="nx">BlogSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">(</span>
  <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">content</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">isLive</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">Boolean</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
      
    <span class="c1">// 1 필요한 model을 내장시킨다.</span>
    <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">ref</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span> <span class="p">},</span>

      <span class="c1">// 여기에는 unique: true 속성을 주면 안된다. (여러 유저가 작성할 수 있음)</span>
      <span class="na">username</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="na">name</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">first</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
        <span class="na">last</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
      <span class="p">},</span>
    <span class="p">},</span>

   <span class="c1">// 2. Schema 자체를 내장시킬 수도 있다. </span>
    <span class="na">comments</span><span class="p">:</span> <span class="p">[</span><span class="nx">CommentSchema</span><span class="p">],</span>
  <span class="p">},</span>
  <span class="p">{</span> <span class="na">timestamps</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span>


<span class="kd">const</span> <span class="nx">Blog</span> <span class="o">=</span> <span class="nx">model</span><span class="p">(</span><span class="dl">"</span><span class="s2">blog</span><span class="dl">"</span><span class="p">,</span> <span class="nx">BlogSchema</span><span class="p">);</span>
<span class="k">export</span> <span class="k">default</span> <span class="nx">Blog</span><span class="p">;</span>

</pre></table></code></div></div><p>이렇게 Schema를 수정하면 다음과 같은 도큐먼트를 확인할 수 있다.</p><p>(Nesting은 이렇게 관련된 데이터를 한번에 저장하는 것이다. <strong>자식 문서를 부모 문서에 아예 저장</strong>시킴으로 Read작업이 정말 간소해진다. )</p><p><img data-src="https://raw.githubusercontent.com/JaeKP/image_repo/main/img/image-20230206225316942.png" alt="image-20230206225316942" data-proofer-ignore></p><p><br /></p><h2 id="2-api-수정-1"><span class="mr-2">2) API 수정</span><a href="#2-api-수정-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>유저나 댓글이 수정, 삭제되면 게시글에 저장된 정보도 같이 수정, 삭제를 해야 한다.</p><p><br /></p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="c1">// src/routes/commentRoute.js</span>

<span class="nx">commentRouter</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:commentId</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">commentId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">content</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">"</span><span class="s2">content is required</span><span class="dl">"</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// comments 배열안에 _id의 값이 comment._id와 동일한 것을 찾아서 수정한다.</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">comment</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
    <span class="nx">Comment</span><span class="p">.</span><span class="nx">findOneAndUpdate</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">commentId</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">content</span> <span class="p">},</span> <span class="p">{</span> <span class="na">new</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}),</span>

    <span class="c1">// $를 사용하면 filter를 통해 선택된 도큐먼트를 가리킨다.</span>
    <span class="c1">// 원래는 comments[index].content = value로 저장해야 하지만 index를 모르기 때문에 $를 사용하는 것이다.</span>
    <span class="c1">// 즉, comments.$는 comments._id가 comment_id인 comment를 의미한다.</span>
    <span class="k">await</span> <span class="nx">Blog</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">({</span> <span class="dl">"</span><span class="s2">comments._id</span><span class="dl">"</span><span class="p">:</span> <span class="nx">commentId</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">comments.$.content</span><span class="dl">"</span><span class="p">:</span> <span class="nx">content</span> <span class="p">}),</span>
  <span class="p">]);</span>

  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">comment</span> <span class="p">});</span>
<span class="p">});</span>

<span class="nx">commentRouter</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:commentId</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">commentId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">comment</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Comment</span><span class="p">.</span><span class="nx">findOneAndDelete</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">commentId</span> <span class="p">});</span>
    
  <span class="c1">// $pull 연산자는 일치하는 모든 값을 모두 제거한다. 만약 일치하는 값이 없다면 도큐먼트는 변경되지 않는다.</span>
  <span class="k">await</span> <span class="nx">Blog</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">({</span> <span class="dl">"</span><span class="s2">comments._id</span><span class="dl">"</span><span class="p">:</span> <span class="nx">commentId</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$pull</span><span class="p">:</span> <span class="p">{</span> <span class="na">comments</span><span class="p">:</span> <span class="p">{</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">commentId</span> <span class="p">}</span> <span class="p">}</span> <span class="p">});</span>

  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">comment</span> <span class="p">});</span>
<span class="p">});</span>
</pre></table></code></div></div><p><br /></p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre><td class="rouge-code"><pre><span class="c1">// src/routes/userRoutes.js</span>

<span class="nx">userRouter</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:userId</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">userId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">isValidObjectId</span><span class="p">(</span><span class="nx">userId</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Invalid userId</span><span class="dl">"</span> <span class="p">});</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">age</span><span class="p">,</span> <span class="nx">name</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">age</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">name</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">"</span><span class="s2">age or name is required</span><span class="dl">"</span> <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">age</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">age</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">number</span><span class="dl">"</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">"</span><span class="s2">age must be a number</span><span class="dl">"</span> <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">name</span><span class="p">.</span><span class="nx">first</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">name</span><span class="p">.</span><span class="nx">last</span> <span class="o">!=</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">"</span><span class="s2">must be string</span><span class="dl">"</span> <span class="p">});</span>

    <span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">age</span><span class="p">)</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ane</span> <span class="o">=</span> <span class="nx">age</span><span class="p">;</span>

    <span class="c1">// user의 이름이 변경되면 블로그, 댓글에 대한 데이터도 변경해야 한다.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>

      <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
        <span class="c1">// updateMany: 다수의 도큐먼트를 수정한다.</span>
        <span class="nx">Blog</span><span class="p">.</span><span class="nx">updateMany</span><span class="p">({</span> <span class="dl">"</span><span class="s2">user._id</span><span class="dl">"</span><span class="p">:</span> <span class="nx">userId</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">user.name</span><span class="dl">"</span><span class="p">:</span> <span class="nx">name</span> <span class="p">}),</span>

        <span class="c1">// array filter를 사용하여 해당 유저가 작성한 모든 코멘트를 수정한다.</span>
        <span class="c1">// update 연산자에서 배열의 엘리먼트에 대한 조건적 업데이트를 지원하는 옵션이다.</span>
        <span class="k">await</span> <span class="nx">Blog</span><span class="p">.</span><span class="nx">updateMany</span><span class="p">(</span>
          <span class="p">{},</span>
          <span class="p">{</span> <span class="dl">"</span><span class="s2">comments.$[elem].user.name</span><span class="dl">"</span><span class="p">:</span> <span class="nx">name</span> <span class="p">},</span>
          <span class="p">{</span> <span class="na">arrayFilters</span><span class="p">:</span> <span class="p">[{</span> <span class="dl">"</span><span class="s2">elem.user._id</span><span class="dl">"</span><span class="p">:</span> <span class="nx">userId</span> <span class="p">}]</span> <span class="p">}</span>
        <span class="p">),</span>
      <span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">user</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">userRouter</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:userId</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">userId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">isValidObjectId</span><span class="p">(</span><span class="nx">userId</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Invalid userId</span><span class="dl">"</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">// 삭제</span>
    <span class="kd">const</span> <span class="p">[</span><span class="nx">user</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
      <span class="nx">User</span><span class="p">.</span><span class="nx">findOneAndDelete</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">userId</span> <span class="p">}),</span>
      <span class="nx">Blog</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">({</span> <span class="dl">"</span><span class="s2">user._id</span><span class="dl">"</span><span class="p">:</span> <span class="nx">userId</span> <span class="p">}),</span>

      <span class="c1">// $pull: {제거할 데이터: {조건}}</span>
      <span class="nx">Blog</span><span class="p">.</span><span class="nx">updateMany</span><span class="p">({</span> <span class="dl">"</span><span class="s2">comments.user._id</span><span class="dl">"</span><span class="p">:</span> <span class="nx">userId</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$pull</span><span class="p">:</span> <span class="p">{</span> <span class="na">comments</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">user._id</span><span class="dl">"</span><span class="p">:</span> <span class="nx">userId</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}),</span>
      <span class="nx">Comment</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">({</span> <span class="na">user</span><span class="p">:</span> <span class="nx">userId</span> <span class="p">}),</span>
    <span class="p">]);</span>

    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="nx">user</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>

</pre></table></code></div></div><p><br /></p><p>하지만, Nesting에도 제한이 있기 때문에 <strong>데이터 구조와 데이터 관계의 성격을 잘 파악</strong>하여 다음 중 하나를 선택하여 DB를 구축하면 된다.</p><ul><li>참조 관계 활용<ul><li>개별적으로 읽을 때도 있거나 내장하려는 문서가 자주 바뀔 경우<li>1:N 관계의 경우 N의 크기가 클 수록</ul><li>Nesting<ul><li>같이 불러올 때가 많고 읽기 비중이 높을 경우<li>1:N 관계의 경우 N의 크기가 작을 수록</ul></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/web/'>WEB</a>, <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >MongoDB</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=MongoDB-Read-%EC%84%B1%EB%8A%A5-%ED%96%A5%EC%83%81%EC%8B%9C%ED%82%A4%EA%B8%B0+-+Hello%2C+World%21&url=https%3A%2F%2Fjaekp.github.io%2Fposts%2Fmogodb03%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=MongoDB-Read-%EC%84%B1%EB%8A%A5-%ED%96%A5%EC%83%81%EC%8B%9C%ED%82%A4%EA%B8%B0+-+Hello%2C+World%21&u=https%3A%2F%2Fjaekp.github.io%2Fposts%2Fmogodb03%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjaekp.github.io%2Fposts%2Fmogodb03%2F&text=MongoDB-Read-%EC%84%B1%EB%8A%A5-%ED%96%A5%EC%83%81%EC%8B%9C%ED%82%A4%EA%B8%B0+-+Hello%2C+World%21" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/mogodb01/">MongoDB-환경설정과-간단한-CRUD구현하기</a><li><a href="/posts/performance03/">실전-웹-성능-최적화-(feat. React)-Part2</a><li><a href="/posts/performance01/">실전-웹-성능-최적화-(feat. React)-Part1</a><li><a href="/posts/nft03/">03-Solidity-문법-기초</a><li><a href="/posts/nft04/">03-DApp-web3를-이용하여-이더리움과-상호작용하기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/til/">til</a> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/vue/">vue</a> <a class="post-tag" href="/tags/cs/">cs</a> <a class="post-tag" href="/tags/django/">django</a> <a class="post-tag" href="/tags/project/">project</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/css/">css</a> <a class="post-tag" href="/tags/react/">React</a> <a class="post-tag" href="/tags/moviewiki/">MovieWiki</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/mogodb01/"><div class="card-body"> <em class="timeago small" data-ts="1675350000" > 2023-02-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MongoDB-환경설정과-간단한-CRUD구현하기</h3><div class="text-muted small"><p> 강의 링크 MongoDB는 NoSQL 데이터 베이스 중 하나이다. NoSQL은 Not Only SQL의 줄임말로 기존의 RDBMS의 한계를 극복하기 위해 만들어진 새로운 형태의 데이터 저장소이다. 관계형 DB는 표를 저장한다면 MongoDB는 객체를 저장한다고 생각하면 된다. 즉, 관계형 DB가 아니므로, RDMS처럼 고정된 스키마 ...</p></div></div></a></div><div class="card"> <a href="/posts/mogodb02/"><div class="card-body"> <em class="timeago small" data-ts="1675350000" > 2023-02-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MongoDB-관계된-데이터-관리</h3><div class="text-muted small"><p> 강의 링크 1. 1:N 관계 1:N 관계는 한 쪽 엔티티가 관계를 맺은 엔티티 쪽의 여러 객체를 가질 수 있는 것을 의미한다. 실제 DB를 설계할 때 자주 쓰이는 방식이다. 1) Schema 작성 일반적인 게시판을 생각하면, 하나의 유저가 여러 개의 게시글을 작성한다. 콜렉션 관계 ...</p></div></div></a></div><div class="card"> <a href="/posts/mogodb04/"><div class="card-body"> <em class="timeago small" data-ts="1675954800" > 2023-02-10 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MongoDB-index를-활용하여-빠른-탐색하기</h3><div class="text-muted small"><p> 1. Index 인덱스는 문서의 필드 값을 색인하여 콜렉션에서 데이터를 빠르게 탐색할 수 있도록 도와 빠른 쿼리 작업을 지원하고 데이터 정렬 및 집계 작업이 효율적으로 실행될 수 있도록 한다. 1) 정의 우리가 사전에서 단어를 빨리 찾을 수 있는 이유는 색인에 따른 정렬이 되어있기 때문이다. 데이터도 탐색을 효율적으로 하기위해 Index를...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/mogodb02/" class="btn btn-outline-primary" prompt="Older"><p>MongoDB-관계된-데이터-관리</p></a> <a href="/posts/mogodb04/" class="btn btn-outline-primary" prompt="Newer"><p>MongoDB-index를-활용하여-빠른-탐색하기</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/JaeKP">박재경</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/til/">til</a> <a class="post-tag" href="/tags/algorithm/">algorithm</a> <a class="post-tag" href="/tags/vue/">vue</a> <a class="post-tag" href="/tags/cs/">cs</a> <a class="post-tag" href="/tags/django/">django</a> <a class="post-tag" href="/tags/project/">project</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/css/">css</a> <a class="post-tag" href="/tags/react/">React</a> <a class="post-tag" href="/tags/moviewiki/">MovieWiki</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/ko.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
